#!/usr/bin/make -f
export DH_VERBOSE = 1

DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/default.mk

export DEB_BUILD_MAINT_OPTIONS = hardening=+all

export PYBUILD_NAME = mailman3-core
export PYBUILD_DESTDIR = debian/mailman3-core

MM3_BIN_DIR=/usr/lib/mailman3/bin/
export PYBUILD_INSTALL_ARGS ?= \
	--install-scripts=${MM3_BIN_DIR}/

%:
	dh $@ --with python3,systemd,sphinxdoc --buildsystem=pybuild

# Running the test suite at build time is not supported for now.
# See upstream bug #400 for further information.
#override_dh_auto_test:
#ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
#	set -e; \
#	for python in $(shell py3versions -r); do \
#		MAILMAN_EXTRA_TESTING_CFG=./debian/contrib/mailman.cfg \
#		PYTHONPATH="." $$python -m nose2 --verbose; \
#	done
#endif

override_dh_auto_build:
	# Builds sphinx doc
	#PYTHONPATH=. sphinx-build -N -q -E -c ./ -b html . debian/compiled_doc/temp
	PYTHONPATH=. sphinx-build -b html -c ./ -E -N . build/sphinx/html
	dh_auto_build

override_dh_auto_install:
	dh_auto_install
	#find debian/mailman3-core/usr -type d -name "tests" -print0 | xargs -0 rm -r

override_dh_installchangelogs:
	dh_installchangelogs src/mailman/docs/NEWS.rst

get-orig-source:
	uscan --verbose --rename
